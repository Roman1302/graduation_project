# ГЛАВА 2. ПРАКТИЧЕСКАЯ РЕАЛИЗАЦИЯ СЕРВИСА

## 2.1 Описание процесса создания Telegram-бота

Перед тем, как приступить к разработке, важно полностью понять принципы работы Telegram-бота. Давайте рассмотрим пример на компьютере с установленным Telegram-клиентом. Вот несколько важных моментов, на которые следует обратить внимание: 

1. Для работы с Telegram-ботом на компьютере необходимо установить интерпретатор Python, а также сервер и клиент Telegram. Это позволит автору проекта создать программу-бота, в которой будет определена логика, шаблоны и возможные операции.

2. Внутри интерпретатора Python будет функционировать программа-бот, в которой опишем логику работы и зададим необходимые операции. Это позволит разработчику управлять Telegram-ботом и обрабатывать запросы пользователей.

3. В приложении, написанном на Python, будем использовать библиотеку для связи с сервером Telegram. В эту библиотеку нужно вшить секретный ключ, чтобы сервер Telegram мог идентифицировать Telegram-бота и установить связь с ним.

4. Когда пользователь в Telegram делает запрос расписания, Telegram-бот загружает необходимые данные на сервер, а сервер выводит результат на компьютер.

5. Запрос пользователя проходит обработку через утилиту на Python, и на сервере Telegram формируется и возвращается необходимый ответ пользователю.

6. Внедрение Telegram-бота в мессенджер происходит без особых трудностей. Описанный принцип действий подходит не только для расписания, но и для любого другого типа Telegram-ботов в мессенджере.

Теперь давайте рассмотрим краткий план действий для разработки Telegram-бота: 

Сначала требуется зарегистрировать нового бота в Telegram. Для этого в поисковой строке мессенджера найдите @BotFather и перейдите к нему. Затем вызовем команду «/Start» в нижней части окна и выберите команду «/newbot» из списка. Telegram-бот попросит указать имя для создаваемого бота (юзернейм). Обратим внимание, что после создания имя будет сложно изменить. Также потребуется указать короткое имя для Telegram-бота. Надежно сохраните токен Telegram-бота — в будущем это понадобится для авторизации и работы с Telegram-ботом.

Название должно быть уникальным, определить его с первого раза не всегда получается.

Очень многие юзернеймы уже заняты. Свободных коротких юзернеймов осталось очень мало.

Юзернейм Telegram-бота выглядит как обычный юзернейм, но должен заканчиваться на «bot».

Есть несколько Telegram-ботов с именами @pic, @vid, @sticker, @gamee — это официальные боты Telegramа, которые не содержат в имени «bot»

Какие существуют лимиты в Telegram для ботов:

    • Количество Telegram-ботов (созданных через @BotFather) до 20 штук

    • Длина @username для Telegram-бота от 5 до 32 символов

    • Длина информации о Telegram-боте (/setabouttext) до 120 символов

    • Длина описания Telegram-бота до 512 символов

    • Файлы отправляемые Telegram-ботом без локального сервера Bot API до 50 МБ

    • Лимит выгрузки файлов с локальным сервером Bot API до 2000 МБ

    • Файлы принимаемые Telegram-ботом без локального сервера Bot API до 20 МБ

    • Лимит загрузки файлов с локальным сервером Bot API до 2000 МБ

    • Количество кнопок до 100 штук

    • Markup-данные сообщения например, inline-кнопки до 10 KB

    • Частота обычной отправки сообщений в групповых чатах до 20 сообщений в минуту в одном чате

    • Количество команд (в BotFather) от 0 до 100 команд

    • Длина команды (в BotFather) от 1 до 32 символов

    • Длина описания команды до 256 символов, должно быть не пустым, если установлено через Bot API

    • Длина метаданных для /start используется для deep linking до 64 байт

    • Длина предупреждения Telegram-бота до 200 символов

    • Количество inline-результатов до 50 элементов на страницу

Когда создается Telegram-бот, BotFather даст его токен. Токен выглядит примерно так: 110201543:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw. Именно с помощью токена можно управлять Telegram-ботом.

В BotFather удобно управлять Telegram-ботами своими командой /mybots

Теперь будет доступно редактирование Telegram-бота. С помощью команд можно изменить аватарку, общее название, описания и т.д. Также в боковую кнопку «Меню» можно зашить ссылку на сайт или социальную сеть.

Основные команды в BotFather:

    • /setname — изменить имя Telegram-бота

    • /setdescription — изменить описание Telegram-бота

    • /setuserpic — изменить аватарку Telegram-бота

    • /setcommands — задать команды для Telegram-бота

    • /deletebot — удалить Telegram-бота

Telegram-бот создан и отображается в поиске, но пока еще ничего не умеет.

Таким образом, первый этап подготовки завершен и можно переходить к следующему.

Открыв Telegram-бота, пользователи могут увидеть его профиль.

Описание (Description) — это текст, который пользователи будут видеть в начале диалога с Telegram-ботом под заголовком «Что может делать этот бот?»

Информация (About) — это текст, который будет виден в профиле Telegram-бота.

Аватарка. Аватарки Telegram-ботов, в отличие от аватарок пользователей и чатов, не могут быть анимированными. Только картинки.

Команды — тут имеются ввиду подсказки команд в Telegram-боте. Подробнее о командах ниже.

Необходимо потратить время и заполните описание и информацию Telegram-бота, чтобы пользователям было понятнее и проще его использовать. Можно оставить там свои контакты и поставьте аватарку, чтобы Telegram-бота было проще отличать от других чатов в списке.

Понятно, что главная функция Telegram-бота — отправлять и получать сообщения.

И то, и другое можно делать со всеми видами сообщений (фото и видео, файлы, опросы, голосовые сообщения и т. д.).

В Telegramе можно делиться файлами до 2 ГБ, но в Bot API более жесткие лимиты: Telegram-боты могут скачивать файлы до 20 МБ и отправлять файлы до 50 МБ.

Если Telegram-бот уже загрузил файл на сервер Telegramа, то может использовать file_id, чтобы отправлять этот файл.

Загружать файл на сервер можно в том числе и по URL файла.

Рассмотрим куда может писать Telegram-бот. Telegram-бот может писать в личку только тем пользователям, которые его запустили. Пользователь может заблокировать Telegram-бота, и тогда Telegram-бот снова не сможет ему писать. Telegram-боты не могут писать другим Telegram-ботам.

Telegram-бота можно добавить в группу (если в BotFather включена соответствующая настройка). По умолчанию видит не все сообщения.

В группе Telegram-боту можно дать права администратора, чтобы он мог выполнять действия админов. В одной группе может быть до 20 Telegram-ботов. В публичные группы (группы с юзернеймом) Telegram-ботов могут добавлять только админы.

Также Telegram-бота можно добавить в канал, причем только как администратора. Самый частый способ использования Telegram-ботов в каналах — добавление кнопок под постами («лайки», ссылки и прочее).

На самом деле многие группы в Telegramе являются супергруппами.

Раньше было четкое разделение на группы и супергруппы. По задумке, супергруппы — это группы для сообществ. Супергруппы могут иметь больше участников, публичные ссылки и другие улучшения.

Со временем, видимо, решили, что это неудобная концепция. Теперь обычная группа становится супергруппой, когда у группы меняются какие-нибудь настройки.

Супергруппу нельзя обратно превратить в группу. С точки зрения API супергруппа устроена так же, как и канал. Важное отличие супергрупп от обычных групп состоит в нумерации сообщений.

Опишем id пользователей и чатов. У каждого пользователя, Telegram-бота, группы, канала в Telegramе есть собственный id. Различать чаты в коде Telegram-бота следует именно по id, потому что он никогда не меняется.

В токене Telegram-бота первая часть — это его id. Например, токен 110201874:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw принадлежит Telegram-боту с id 110201874.

В Bot API перед id супергрупп и каналов пишется -100. Так, id 1356415630 превращается в -1001356415630.

Не рекомендуется хранить id пользователей и чатов в 32-битном типе числа: теперь id могут превышать 231-1.

Каждое сообщение в Telegramе имеет свой id. Это относится и к системным сообщениям (пользователь зашел в группу, изменилось название группы и т. д.). Через Telegram API Telegram-боты могут получать по запросу сообщения в любом чате по их id. У сообщений id в супергруппах и каналах уникальны для чата: первое сообщение в чате имеет номер 1, второе имеет номер 2 и так далее.

У сообщений id в личных сообщениях и обычных группах работают по другому. Там, можно сказать, нумерация сквозная: id сообщения уникально для каждого отправившего его пользователя. Так, первое сообщение от пользователя во всех личных переписках и группах имеет номер 1, второе сообщение от того же пользователя имеет номер 2 и так далее.

Видимость сообщений в группах для Telegram-ботов обычно начинается именно на команды. Telegram не уведомляет Telegram-бота об остальных сообщениях, и это гарантирует приватность переписки.

Но если Telegram-боту нужно видеть все сообщения в группе (например, если это Telegram-бот или антиспам-бот), для него можно отключить Privacy mode.

Privacy mode — настройка в BotFather, которая по умолчанию включена. В таком режиме Telegram-бот в группах видит только такие сообщения:

    • Сообщения с упоминанием Telegram-бота;

    • Ответы на сообщение Telegram-бота, ответы на ответы и так далее;

    • Системные сообщения;

    • Команды для Telegram-бота.

Если Privacy mode выключен, то Telegram-бот видит все сообщения в группе, Telegram-бот-админ в группе, в любом случае видит все сообщения.

Telegram-бот, работающий через Bot API, в любом случае не будет видеть сообщения от других Telegram-ботов.

В группах могут быть не только сообщения от пользователей, так же могут быть:

    • Сообщения в группе из привязанного канала (с точки зрения API это пересланные сообщения)

    • Сообщения от лица группы от анонимных администраторов той же группы

    • Сообщения от лица публичных каналов от любых пользователей

Это стоит учитывать при разработке Telegram-ботов для групп.

Часто используемый способ «общения» пользователей с Telegram-ботом — команды. Команды начинаются на «/» и состоят из латинских букв (можно использовать цифры и нижние подчеркивания).

Команды подсвечиваются как ссылки: нажатие отправляет команду в чат.

В группах, чтобы различать команды от разных Telegram-ботов, Telegram предлагает ставить в конце команды юзернейм Telegram-бота. Например: «/start@examplebot».

В BotFather можно указать подсказки команд для Telegram-бота. Он будут отображаться при вводе «/» и команд. Если есть подсказки, рядом с кнопкой «Отправить» появляется кнопка для открытия меню команд.

Если в подсказках команд «/help», в профиле Telegram-бота появляется кнопка «Помощь с ботом». Нажатие на кнопку отправляет эту команду.

Если в подсказках команд есть «/settings», в профиле Telegram-бота появляется кнопка «Настройки бота». Нажатие на кнопку отправляет эту команду.

С 2021 года Telegram-боты могут показывать разные меню команд для разных пользователей и групп, а также меню команд может зависеть от языка пользователя и того, является ли участник группы админом.

Как можно заметить, сообщения в Telegramе могут содержать не только обычный текст, но и жирный, курсив и др. В Bot API разметку сообщений можно делать в HTML и Markdown.

В Telegram API для разметки надо вместе с сообщением передавать entities (MessageEntityBold, MessageEntityItalic и так далее). Хорошие библиотеки сами превращают HTML или Markdown в текст и entities.

Способы выделения текста:

    • Жирный текст

    • Курсив

    • Подчёркнутый текст

    • Зачёркнутый текст

    • Моноширинный текст («в строке» и «блоком»)

    • Ссылка (встроенная в текст)

    • Спойлер — текст, который показывается только после нажатия на плашку

Упоминание пользователя — это текст, похожий на ссылку, клик по которому открывает профиль пользователя. Если упомянуть в группе её участника, он получит уведомление. Чтобы вставить в сообщение упоминание пользователя, в Bot API нужно встроить ссылку на «tg://user?id=123456789».

Telegram-бот может оставлять кнопки под своими сообщениями. Кнопки под сообщениями (они же inline keyboards или inline buttons) в основном бывают трёх видов:

    • URL button — кнопка с ссылкой.

    • Callback button. При нажатии на такую кнопку Telegram-боту придёт апдейт. С созданием кнопки можно указать параметр, который будет указан в этом апдейте (до 64 байтов). Обычно после нажатий на такие кнопки Telegram-боты изменяют исходное сообщение или показывают notification или alert.

    • Switch to inline button. Кнопка для переключения в инлайн-режим. Кнопка может открывать инлайн в том же чате или открывать меню для выбора чата. Можно указать в кнопке запрос, который появится рядом с никнеймом Telegram-бота при нажатии на кнопку.

Есть другой тип кнопок: keyboard buttons. Они отображаются вместо клавиатуры как подсказки. При нажатии на такую кнопку пользователь просто отправит этот текст. При этом в личных чатах с помощью кнопки можно:

    • Запросить номер телефона пользователя,

    • Запросить геолокацию пользователя,

    • Открыть у пользователя меню создания опроса.

Есть опция resize_keyboard, которая отвечает за то, изменять ли высоту этой «клавиатуры из кнопок». По умолчанию она, обычно, выключена, и тогда высота клавиатуры стандартная большая.

Инлайн-режим (inline mode) — это специальный режим работы Telegram-бота, с помощью которого пользователь может использовать Telegram-бота во всех чатах. Пользователь вводит юзернейм Telegram-бота в поле для ввода сообщения. После юзернейма можно ещё записать запрос (текст до 256 символов). Появляется меню с результатами. Выбирая результат, пользователь отправляет сообщение.

Инлайн-режим можно включить в BotFather, там же можно выбрать плейсхолдер вместо стандартного «Search...»

В группе можно запретить использовать инлайн всем или некоторым участникам. В официальных приложениях Telegram это ограничение объединено с ограничением на отправку стикеров и GIF.

Таким образом, процесс создания Telegram-бота на языке программирования Pyhton складывается из многочисленных особенностей Telegram, который предписывает определенные команды и ограничения для разработчиков, создающих Telegram-ботов, как по функционалу, так и по оформлению.