## 2.2 Описание реализации Telegram-бота на языке программирования Pyhton с помощью фреймворка aiogram

Для начала реализации создадим файл с базовым шаблоном Telegram-бота на aiogram. 

Основная особенность этой библиотеки заключается в том, что она асинхронная, что означает, что все хэндлеры должны быть асинхронными, а вызовы методов API должны содержать ключевое слово await, так как они возвращают корутины. 

Корутины - это паттерн проектирования, который позволяет писать асинхронные программы, способные выполнять несколько задач одновременно. В отличие от традиционных потоков, где задачи выполняются параллельно и могут блокировать друг друга, корутины позволяют приостанавливать выполнение одной задачи и переключаться на другую. Это позволяет более эффективно использовать ресурсы процессора и памяти. Корутины - это легковесные вычисления, которые работают поверх потоков. Они могут быть приостановлены и возобновлены в любой момент, что позволяет эффективно использовать ресурсы процессора. Когда корутина приостанавливается, связанные с ней вычисления сохраняются в памяти и освобождают поток для выполнения других задач. Это позволяет выполнять несколько корутин одновременно в рамках ограниченного пула потоков, что снижает нагрузку на системные ресурсы. 

В aiogram, чтобы создать асинхронного Telegram-бота, необходимо использовать декоратор «@dp.message_handler» для обработки входящих сообщений. Этот декоратор принимает различные параметры, такие как текстовые фильтры и типы сообщений, которые должны быть обработаны. Затем определяем асинхронную функцию, которая будет вызываться, когда подходящее сообщение будет получено. Внутри этой функции можем выполнять различные действия, такие как отправка сообщений, обработка данных и т. д. Кроме того, aiogram предоставляет удобный интерфейс для работы с различными асинхронными методами API Telegram. Можно использовать ключевое слово await для ожидания ответа от API и дальнейшей обработки полученных данных. Например, можем отправить сообщение с помощью метода «@bot.send_message» и дождатьcя ответа, чтобы убедиться, что сообщение было успешно отправлено. 

В целом, aiogram предоставляет мощный инструментарий для разработки асинхронных ботов на платформе Telegram. Благодаря использованию корутин и эффективному управлению ресурсами, можем создавать Telegram-ботов, которые могут обрабатывать большое количество запросов одновременно, минимизируя нагрузку на систему.

На что стоит обратить внимание по сравнению с другой библиотекой для Telegram, например, pyTelegramBotAPI, концепция хэндлеров (обработчиков событий), разница лишь в том, что в aiogram хэндлерами управляет диспетчер.

Диспетчер регистрирует функции-обработчики, дополнительно ограничивая перечень вызывающих их событий через фильтры. После получения очередного апдейта (события от Telegram), диспетчер выберет нужную функцию обработки, подходящую по всем фильтрам, например, «обработка сообщений, являющихся изображениями, в чате с ID икс и с длиной подписи игрек». Если две функции имеют одинаковые по логике фильтры, то будет вызвана та, что зарегистрирована раньше.

Чтобы зарегистрировать функцию как обработчик сообщений, нужно сделать одно из двух действий:

1. Навесить на неё декоратор, как в примере выше.

2. Напрямую вызвать метод регистрации у диспетчера или роутера.

Для того чтобы сделать код чище и читабельнее, aiogram расширяет возможности стандартных объектов Telegram. Например, вместо «bot.send_message(…)» можно написать «message.answer(…)» или «message.reply(...)». В последних двух случаях не нужно подставлять chat_id, подразумевается, что он такой же, как и в исходном сообщении.

Разница между answer и reply простая: первый метод просто отправляет сообщение в тот же чат, второй делает «ответ» на сообщение из message.

Более того, для большинства типов сообщений есть вспомогательные методы вида «answer_{type}» или «reply_{type}».

Существует ряд ситуаций, когда при запуске Telegram-бота необходимо передать несколько дополнительных значений. Может быть, это будет какая-нибудь переменная или же объект конфигурации, список чего-то, отметка времени и так далее. Для этой цели достаточно передать указанные данные в качестве наименованных (kwargs) аргументов в диспетчере или присвоить значения, как если бы работали со словарем. Это особенно удобно для передачи объектов, которые должны существовать в единственном экземпляре и не изменяться в процессе работы Telegram-бота (то есть быть только для чтения). Если предполагается, что значение будет изменяться со временем, необходимо помнить, что это будет работать только с изменяемыми объектами. Чтобы получить значения в хэндлерах, просто указывайте их как аргументы.

Для обеспечения безопасности и избежания хранения токена прямо в коде, можно поместить такие данные в отдельный конфигурационный файл. В нашей работе будем использовать отдельные файлы формата .env. Это позволит легко управлять конфиденциальными данными и обеспечить безопасность информации.

Очень важно отметить, что передача информации в виде аргументов и использование файлов конфигурации .env являются эффективными методами для работы с данными в Telegram-боте. Эти подходы позволяют гибко управлять информацией и обеспечивают безопасность и конфиденциальность данных. В этой части подробно рассмотрим применение различных форматирований к сообщениям и работу с мультимедийными файлами.

Одна из ключевых задач большинства Telegram-ботов - это обработка текстовых сообщений. Текст может быть использован для выражения практически любой информации, и важно представлять ее красиво. Разработчику доступны три способа разметки текста: HTML, Markdown и MarkdownV2. Среди них наиболее продвинутыми считаются HTML и MarkdownV2, в то время как «классический» Markdown имеет ограниченные возможности и больше не используется в aiogram.

Перед тем, как приступить к изучению возможностей работы с текстом в aiogram, важно отметить одно важное отличие между версией aiogram 3.x и 2.x: в «двойке» по умолчанию обрабатывались только текстовые сообщения, тогда как в «тройке» можно обрабатывать сообщения любого типа. Одним из аргументов, отвечающих за выбор форматирования при отправке сообщений, является параметр parse_mode.

Если в Telegram-боте часто применяется одно и то же форматирование, то каждый раз указывать аргумент parse_mode может быть неудобно. Однако, в aiogram есть возможность передать необходимый тип прямо в объект Bot. И если в какой-то конкретной ситуации не требуется использовать форматирование, просто укажите parse_modeNone.

Нередко бывают ситуации, когда окончательный текст сообщения Telegram-бота заранее неизвестен и формируется исходя из каких-то внешних данных: имя пользователя, его ввод и т.д. Напишем хэндлер на команду «/hello», который будет приветствовать пользователя по его полному имени (first_name + last_name), например: «Hello, Иван Иванов».

Разработчики могут воспользоваться удобствами Telegram, которые значительно упрощают их жизнь. Предварительная обработка сообщений пользователей на стороне Telegram позволяет избежать необходимости использования регулярных выражений для извлечения определенных сущностей, таких как адрес электронной почты, номер телефона, имя пользователя и другие. Вместо этого, можно получить эти данные непосредственно из объекта Message и его поля entities, содержащего массив объектов типа MessageEntity. Чтобы проиллюстрировать это, напишем обработчик, который извлекает ссылку, адрес электронной почты и моноширинный текст из сообщения, по одному элементу каждого типа.

Здесь кроется важный подвох. Telegram возвращает не сами значения, а их начало в тексте и длину. Более того, текст считается в символах UTF-8, а entities работают с UTF-16, из-за этого, если просто взять позицию и длину, то при наличии UTF-16 символов (например, эмодзи) ваш обработанный текст просто сместиться.

Telegram предоставляет пользователям множество способов ввода информации. Одним из них являются команды: ключевые слова, начинающиеся со слэша, например, «/new» или «/ban». Иногда Telegram-бот может быть спроектирован так, чтобы ожидать после самой команды какие-то аргументы, вроде «/ban 2d» или «/settimer 20h This is delayed message». В составе aiogram есть фильтр Command(), упрощающий жизнь разработчика.

Telegram предлагает не только текстовые сообщения, но и возможность обмениваться различными медиафайлами, такими как фото, видео, гифки, геолокации и стикеры. Каждый из этих медиафайлов имеет свой уникальный идентификатор файла (file_id) и уникальный идентификатор файла (file_unique_id). Используя file_id, можно многократно отправлять один и тот же файл, при этом отправка будет мгновенной, так как сам файл уже хранится на серверах Telegram. Этот способ является наиболее предпочтительным.

В отличие от file_id, идентификатор file_unique_id нельзя использовать для повторной отправки или скачивания медиафайла, но зато он одинаковый у всех Telegram-ботов для конкретного медиа. Нужен file_unique_id обычно тогда, когда нескольким Telegram-ботам требуется знать, что их собственные file_id односятся к одному и тому же файлу.

Когда файл ещё не присутствует на сервере Telegram, Telegram-бот имеет возможность загрузить его по трем различным путям: как файл из файловой системы, используя ссылку или напрямую предоставив набор байтов. Это позволяет ускорить процесс отправки и обеспечить более аккуратное обращение к серверам мессенджера. Важно правильно выполнить загрузку (upload) файлов на Telegram только один раз и затем использовать полученный file_id, который будет доступен после первой загрузки медиа.

В aiogram 3.x присутствуют 3 класса для отправки изображений - FSInputFile, BufferedInputFile, URLInputFile.

В этой части погрузимся в описание свойства Telegram-ботов, как использование кнопок. Прежде всего, чтобы не путаться, давайте определимся с терминологией. Одни, которые закрепляются внизу экрана вашего устройства, будем называть простыми кнопками, а те, что присоединяются к сообщениям, - инлайн-кнопками.

Вместе с появлением Bot API в далеком 2015 году появился и этот вариант кнопок, которые представляют собой шаблоны сообщений. Принцип работы простой - то, что написано на кнопке, будет отправлено в текущий чат. Таким образом, для обработки нажатия кнопки Telegram-боту необходимо распознавать входящие текстовые сообщения.

В Telegram существует шесть специальных видов обычных кнопок, не являющихся обычными шаблонами сообщений. Они предназначены для:

    • отправки текущей геолокации;

    • отправки своего контакта с номером телефона;

    • создания опроса или викторины;

    • выбора и отправки Telegram-боту данных пользователя с нужными критериями;

    • выбора и отправки Telegram-боту данных (супер) группы или канала с нужными критериями;

    • запуска веб-приложения (WebApp).

Опишем них подробнее.

Отправка текущей геолокации. Здесь всё просто: где пользователь находится, те координаты и отправляет. Это будет статическое гео, а не Live Location, который обновляется автоматически.

Отправка своего контакта с номером телефона стало проще, благодаря кнопке «Отправить контакт» с предварительным подтверждением. Когда пользователь нажимает на эту кнопку, Telegram-бот получает его контакт с номером телефона. Кроме того, для предотвращения мошенничества, была реализована проверка наличия совпадений между отправленным контактом и профилем пользователя. Таким образом, даже если некоторые пользователи попытаются обойти кнопку и отправить другой контакт, сможем обнаружить такие случаи и принять соответствующие меры: достаточно проверить в хэндлере или в фильтре равенство «message.contact.user_id == message.from_user.id».

Создание опроса или викторины. По нажатию на кнопку пользователю предлагается создать опрос или викторину, которые потом отправятся в текущий чат. Необходимо передать объект KeyboardButtonPollType, необязательный аргумент type служит для уточнения типа опроса (опрос или викторина).

Выбор и отправка Telegram-боту данных пользователя с нужными критериями. Показывает окно выбора пользователя из списка чатов юзера, нажавшего на кнопку. Необходимо передать объект KeyboardButtonRequestUser, в котором надо указать сгенерированный любым способом айди запроса и критерии, например, «бот», «есть подписка Telegram Premium» и т.д. После выбора юзера Telegram-бот получит сервисное сообщение с типом UserShared.

Выбор и отправка Telegram-боту чата с нужными критериями. Показывает окно выбора пользователя из списка чатов юзера, нажавшего на кнопку. Необходимо передать объект KeyboardButtonRequestChat, в котором надо указать сгенерированный любым способом айди запроса и критерии, например, «группа или канал», «юзер — создатель чата» и т.д. После выбора юзера Telegram-бот получит сервисное сообщение с типом ChatShared.

Запуск веб-приложения (WebApp). При нажатии на кнопку открывает WebApp. Необходимо передать объект WebAppInfo. 

В отличие от обычных кнопок, инлайновые цепляются не к низу экрана, а к сообщению, с которым были отправлены. В этой части рассмотрим два типа таких кнопок: URL и Callback.

Самые простые инлайн-кнопки относятся к типу URL, т.е. «ссылка». Поддерживаются только протоколы HTTP(S) и «tg://».

В марте 2019 года разработчики Telegram добавили возможность отключать переход к профилю пользователя у пересланного сообщения. При попытке создать URL-кнопку с ID юзера, у которого отключен переход по форварду, Telegram-бот получит ошибку Bad Request: BUTTON_USER_PRIVACY_RESTRICTED. Соответственно, прежде чем показывать такую кнопку, необходимо выяснить состояние упомянутой настройки. Для этого можно вызвать метод getChat и в ответе проверить состояние поля has_private_forwards. Если оно равно True, значит, попытка добавить URL-ID кнопку приведёт к ошибке.

Telegram-бота — это приложение, которое должно работать круглосуточно. Для этого есть хостинги, которые работают на постоянной основе. Конечно, можно развернуть доступ и на личном компьютере, но в этом случае компьютер будет выполнять роль сервера и его нельзя будет отключать от сети. Еще одна особенность — это пропускная способность Интернет-соединения, как правило, у хостинга эти показатели очень отличаются от обычного доступа.

Для развертывания бота для Telegram лучше всего подходит VDS/VPS. Он не требует наличия домена в обязательном порядке, и к нему можно будет обратиться по выделенному IP-адресу, что удобно при развертывании Telegram-бота. К тому же такие серверы лучше поддерживают увеличение масштабов проекта, так что при увеличении потока посетителей вам не придется переходить на другой сервер — достаточно будет просто сменить тариф или его настройки.

Таким образом при соблюдении особенностей применения модулей и знания языка программирования Pyhton с помощью фреймворка aiogram можно разработать Telegram-бот и разместить его на хостинге с круглосуточным режимом работы. Саму разработку Telegram-бота «Расписание Сыктывкара» опишем ниже.